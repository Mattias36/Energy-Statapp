{% extends "base.html" %}
{% block page_content %}
{% load custom_filter %}

<div class="detail-wrapper">

  <h1 class="page-title">{{ selected_category.name }} for {{ selected_country }}</h1>

  <!-- INSIGHTS SECTION -->
  <div class="info-section">
    <h2>Energy Summary Overview</h2>
    <div class="insight-item">
      <strong>Nuclear Investment Status:</strong> {{ nuclear_status|safe }}
    </div>
    <div class="insight-item">
      <strong>Natural Gas Trend:</strong> {{ gas_status|safe }}
    </div>
    <div class="insight-item">
      <strong>Total Renewables (Latest Year):</strong> <span>{{ renewable_total }}</span>
    </div>
    <div class="insight-item">
      <strong>Waste / Non-Renewable Waste:</strong> <span>{{ waste_total }}</span>
    </div>
  </div>

  <!-- TABLE SECTION - tabela do testowania czy dane się zgadzają--> 
  <!-- <section class="data-table">
    <h2>Dane produkcji energii</h2>
    {% if selected_country %}
      <p>Wyświetlanie danych dla <strong>{{ selected_country }}</strong></p>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Źródło energii</th>
              {% for year in years %}
                <th>{{ year }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for source, values_by_year in table.items %}
            <tr>
              <td>{{ source }}</td>
              {% for year in years %}
                <td>{{ values_by_year|get_item:year|floatformat:3|default:"–" }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
            <tr class="total-row">
              <td>Łącznie</td>
              {% for year in years %}
                <td>{{ total_by_year|get_item:year|floatformat:3|default:"–" }}</td>
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>
    {% else %}
      <p>Wybierz kraj, aby wyświetlić dane.</p>
    {% endif %}
    </section> -->


  <!-- CHART CONTROLS SECTION -->
  <div class="chart-section">
    <h2>Total Production Chart (Mtoe)</h2>

    <div class="form-group">
      <label for="yearRange">Select Year Range:</label>
      <input type="range" id="yearRange" min="0" max="{{ total_years|length|add:" -1" }}" 
             value="{{ total_years|length|add:" -1" }}" step="1" 
             oninput="updateChartRange(this.value)">
      <span id="selectedRangeLabel">All years</span>
    </div>

    <div class="form-group">
      <label for="graph_type">Select Graph Type:</label>
      <select name="graph_type" id="graph_type">
          <option value="bar" {% if graph_type == 'bar' %}selected{% endif %}>Bar</option>
          <option value="line" {% if graph_type == 'line' %}selected{% endif %}>Line</option>
      </select>
    </div>

    <div class="button-group">
      <button id="generateGraphButton">Generate Graph</button>
      <button id="saveImageButton">Save</button>
    </div>

    <form id="compareForm" class="form-group">
      <label for="compareCountries">Compare with other countries:</label>
      <select id="compareCountries" name="compare_countries" multiple>
        {% for country in countries %}
          {% if country.name != selected_country %}
            <option value="{{ country.code }}">{{ country.name }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </form>

    <div id="graphContainer" style="display:none; margin-top: 20px;">
        <canvas id="totalChart" width="800" height="400"></canvas>
        {{ total_years|json_script:"total-years" }}
        {{ total_values|json_script:"total-values" }}
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- (JS pozostaje bez zmian) -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const totalYears = JSON.parse(document.getElementById('total-years').textContent);
        const totalValues = JSON.parse(document.getElementById('total-values').textContent);
        const graphTypeSelect = document.getElementById("graph_type");
        const compareSelect = document.getElementById("compareCountries");
        const yearRange = document.getElementById("yearRange");
        const selectedRangeLabel = document.getElementById("selectedRangeLabel");
        const graphContainer = document.getElementById("graphContainer");
        const ctx = document.getElementById("totalChart").getContext("2d");
    
        let chartInstance = null;
    
        function getCurrentValues(maxIndex) {
            return {
                years: totalYears.slice(0, maxIndex + 1),
                values: totalValues.slice(0, maxIndex + 1)
            };
        }
    
        function updateChartRange(value) {
            const rangeValue = parseInt(value);
            const current = getCurrentValues(rangeValue);
            selectedRangeLabel.textContent = `${current.years[0]} – ${current.years.slice(-1)[0]}`;
        }
    
        function renderChart(type = "bar", maxIndex = totalYears.length - 1, extraData = []) {
            const current = getCurrentValues(maxIndex);
    
            const datasets = [
                {
                    label: "Total:",
                    data: current.values,
                    backgroundColor: "rgba(54, 162, 235, 0.6)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    fill: type === "line",
                    tension: 0.3
                }
            ];
    
            // Dodaj dane porównywane
            extraData.forEach(item => {
                datasets.push({
                    label: item.name,
                    data: item.values.slice(0, maxIndex + 1),
                    backgroundColor: item.color + "80",
                    borderColor: item.color,
                    fill: type === "line",
                    tension: 0.3
                });
            });
    
            if (chartInstance) {
                chartInstance.destroy();
            }
    
            chartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: current.years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "top"
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
    
            graphContainer.style.display = "block";
        }
    
        document.getElementById("generateGraphButton").addEventListener("click", async () => {
            const maxIndex = parseInt(yearRange.value);
            const type = graphTypeSelect.value;
    
            // Pobieranie krajów do porównania
            const selectedOptions = Array.from(compareSelect.selectedOptions);
            const selectedCodes = selectedOptions.map(opt => opt.value);
    
            let extraData = [];
    
            if (selectedCodes.length > 0) {
                const queryParams = selectedCodes.map(code => `countries[]=${code}`).join("&");
                const response = await fetch(`/compare_data/?${queryParams}`);

                const data = await response.json();
    
                // Generowanie losowych kolorów i datasetów
                extraData = data.map(entry => ({
                    name: entry.name,
                    values: entry.total_values,
                    color: getRandomColor()
                }));
            }
    
            renderChart(type, maxIndex, extraData);
        });
    
        function getRandomColor() {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            return `rgba(${r}, ${g}, ${b}, 1)`;
        }
    
        document.getElementById('saveImageButton').addEventListener('click', function () {
        const chartContainer = document.getElementById('graphContainer');

        if (chartContainer.style.display === 'none') {
            alert('Proszę najpierw wygenerować wykres do pobrania');
            return;
        }
    
        chartContainer.scrollIntoView({ behavior: "smooth" });
    
        html2canvas(chartContainer).then(canvas => {
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                // temp link element for download
                const link = document.createElement('a');
                link.href = url;
                link.download = 'energy_production_chart.png';
                link.click();
                // revoke Blob URL
                URL.revokeObjectURL(url);
            }, 'image/png');
        });
});
    
        // Inicjalizacja
        updateChartRange(yearRange.value);
    });
</script>
    
{% endblock page_content %}
