{% extends "base.html" %}
{% block page_content %}
{% load custom_filter %}
{% load static %}
<head>
  <meta charset="UTF-8" />
  <title>Country Energy Details</title>
  <style>
/*  link stylesheet static nie dziala? dodac do osobnych plikow*/
.insights {
  text-align: center;
  max-width: 400px;
  margin: 20px auto;
  font-family: Arial, sans-serif;
}
    .tooltip {
      position: relative;
      cursor: help;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: max-content;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 4px;
      padding: 5px 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%; /*  above */
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 600px;
      margin: 1rem auto;
      font-family: Arial, sans-serif;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem 1rem;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }
    .color-green {
      color: green;
      font-weight: bold;
    }
    .color-red {
      color: red;
      font-weight: bold;
    }
    .color-gray {
      color: gray;
      font-weight: bold;
    }
  </style>
</head>


<div class="detail-wrapper">

  <h1 class="page-title">{{ selected_category.name }} for {{ selected_country }}</h1>

<!-- update for bubbles for better view --->
<div class="insights bubble-grid">
  <div class="bubble tooltip">
    <strong>Nuclear Investment Status:</strong><br>
    {{ nuclear_status|safe }}
    <span class="tooltiptext">Procentowy udział energii jądrowej w całkowitej produkcji energii danego kraju.</span>
  </div>
  <div class="bubble tooltip">
    <strong>Natural Gas Trend:</strong><br>
    {{ gas_status|safe }}
    <span class="tooltiptext">Roczna zmiana procentowa udziału gazu ziemnego w produkcji energii</span>
  </div>
  <div class="bubble tooltip">
    <strong>Total Renewables (Latest Year):</strong><br>
    <span>{{ renewable_total }}</span>
    <span class="tooltiptext">Całkowita produkcja energii ze źródeł odnawialnych</span>
  </div>
  <div class="bubble tooltip">
    <strong>Waste / Non-Renewable Waste:</strong><br>
    <span>{{ waste_total }}</span>
    <span class="tooltiptext">Opis Waste / Non-Renewable Waste.</span>
  </div>
</div>

<table>
    <thead>
    <tr>
        <th>Energy Source</th>
        <th>Country Share</th>
        <th>Rank</th>
    </tr>
    </thead>
    <tbody>
    {% for source, info in country_rankings.items %}
    <tr>
        <td>{{ source }}</td>
        <td class="tooltip">
            {% if info.share_percent > info.average %}
            <span class="color-green">
            {% elif info.share_percent < info.average %}
              <span class="color-red">
            {% else %}
              <span class="color-gray">
            {% endif %}
                {{ info.share_percent|default:"–"|floatformat:1 }}%
              </span>
            <span class="tooltiptext">
              Average in EU: {{ info.average|default:"–"|floatformat:1 }}%
            </span>
        </td> <!--- idk why not closed???? --->
        <td>{{ info.rank|default:"–" }}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="3" style="text-align:center;">No data available</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<div class="predictions">
  <h3 style="text-align: center; margin-bottom: 20px;">Predicted Energy Usage</h3>
  <div class="bubble-grid">
      {% for source, info in future_usage.items %}
      {# iteracja po wszystkich zrdolach energii i ich danych w future_usage , zmienne val_2025,20206#}
      {% with val_2025=info.predictions.2025 val_2026=info.predictions.2026 %}
      {% if val_2025 and val_2025 != 0 and val_2026 and val_2026 != 0 %}
      <div class="bubble">
          <strong>{{ source }}</strong><br>
          <span class="
              {% if val_2026 > val_2025 %}
                up
              {% elif val_2026 < val_2025 %}
                down
              {% else %}
                neutral
              {% endif %}
            ">
              {{ val_2025|floatformat:1 }} → {{ val_2026|floatformat:1 }}
            </span>
          <span class="tooltiptext">{{ info.tooltip }}</span>
      </div>
      {% endif %}
      {% endwith %}
      {% endfor %}
  </div>
</div>

<style>
.bubble-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 items per row */
  gap: 20px;
  justify-items: center;
  max-width: 800px;
  margin: 0 auto;
}

.bubble {
  background-color: #eef3fa;
  border: 2px solid #d0dbe8;
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  position: relative;
  font-size: 14px;
  cursor: pointer;
  transition: transform 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 160px;
}

.bubble:hover {
  transform: scale(1.05);
  background-color: #dde8f7;
}

.bubble .tooltiptext {
  visibility: hidden;
  white-space: pre-line;
  background-color: #333;
  color: #fff;
  text-align: left;
  border-radius: 6px;
  padding: 8px;
  position: absolute;
  z-index: 10;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s;
  min-width: 150px;
}

.bubble:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
</style>

  <!-- INSIGHTS SECTION -->
  <div class="info-section">
    <h2>Energy Summary Overview</h2>
    <div class="insight-item">
      <strong>Nuclear Investment Status:</strong> {{ nuclear_status|safe }}
    </div>
    <div class="insight-item">
      <strong>Natural Gas Trend:</strong> {{ gas_status|safe }}
    </div>
    <div class="insight-item">
      <strong>Total Renewables (Latest Year):</strong> <span>{{ renewable_total }}</span>
    </div>
    <div class="insight-item">
      <strong>Waste / Non-Renewable Waste:</strong> <span>{{ waste_total }}</span>
    </div>
  </div>

  <!-- TABLE SECTION - tabela do testowania czy dane się zgadzają--> 
  <!-- <section class="data-table">
    <h2>Dane produkcji energii</h2>
    {% if selected_country %}
      <p>Wyświetlanie danych dla <strong>{{ selected_country }}</strong></p>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Źródło energii</th>
              {% for year in years %}
                <th>{{ year }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for source, values_by_year in table.items %}
            <tr>
              <td>{{ source }}</td>
              {% for year in years %}
                <td>{{ values_by_year|get_item:year|floatformat:3|default:"–" }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
            <tr class="total-row">
              <td>Łącznie</td>
              {% for year in years %}
                <td>{{ total_by_year|get_item:year|floatformat:3|default:"–" }}</td>
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>
    {% else %}
      <p>Wybierz kraj, aby wyświetlić dane.</p>
    {% endif %}
    </section> -->


  <!-- CHART CONTROLS SECTION -->
  <div class="chart-section">
    <h2>Total Production Chart (Mtoe)</h2>

    <div class="form-group">
      <label for="yearRange">Select Year Range:</label>
      <input type="range" id="yearRange" min="0" max="{{ total_years|length|add:" -1" }}" 
             value="{{ total_years|length|add:" -1" }}" step="1" 
             oninput="updateChartRange(this.value)">
      <span id="selectedRangeLabel">All years</span>
    </div>

    <div class="form-group">
      <label for="graph_type">Select Graph Type:</label>
      <select name="graph_type" id="graph_type">
          <option value="bar" {% if graph_type == 'bar' %}selected{% endif %}>Bar</option>
          <option value="line" {% if graph_type == 'line' %}selected{% endif %}>Line</option>
      </select>
    </div>

    <div class="button-group">
      <button id="generateGraphButton">Generate Graph</button>
      <button id="saveImageButton">Save</button>
    </div>

    <form id="compareForm" class="form-group">
      <label for="compareCountries">Compare with other countries:</label>
      <select id="compareCountries" name="compare_countries" multiple>
        {% for country in countries %}
          {% if country.name != selected_country %}
            <option value="{{ country.code }}">{{ country.name }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </form>

    <div id="graphContainer" style="display:none; margin-top: 20px;">
        <canvas id="totalChart" width="800" height="400"></canvas>
        {{ total_years|json_script:"total-years" }}
        {{ total_values|json_script:"total-values" }}
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- (JS pozostaje bez zmian) -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const totalYears = JSON.parse(document.getElementById('total-years').textContent);
        const totalValues = JSON.parse(document.getElementById('total-values').textContent);
        const graphTypeSelect = document.getElementById("graph_type");
        const compareSelect = document.getElementById("compareCountries");
        const yearRange = document.getElementById("yearRange");
        const selectedRangeLabel = document.getElementById("selectedRangeLabel");
        const graphContainer = document.getElementById("graphContainer");
        const ctx = document.getElementById("totalChart").getContext("2d");
    
        let chartInstance = null;
    
        function getCurrentValues(maxIndex) {
            return {
                years: totalYears.slice(0, maxIndex + 1),
                values: totalValues.slice(0, maxIndex + 1)
            };
        }
    
        function updateChartRange(value) {
            const rangeValue = parseInt(value);
            const current = getCurrentValues(rangeValue);
            selectedRangeLabel.textContent = `${current.years[0]} – ${current.years.slice(-1)[0]}`;
        }
    
        function renderChart(type = "bar", maxIndex = totalYears.length - 1, extraData = []) {
            const current = getCurrentValues(maxIndex);
    
            const datasets = [
                {
                    label: "{{ selected_country }}",
                    data: current.values,
                    backgroundColor: "rgba(54, 162, 235, 0.6)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    fill: type === "line",
                    tension: 0.3
                }
            ];
    
            // Dodaj dane porównywane
            extraData.forEach(item => {
                datasets.push({
                    label: item.name,
                    data: item.values.slice(0, maxIndex + 1),
                    backgroundColor: item.color.replace('1)', '0.5)'),
                    borderColor: item.color,
                    fill: type === "line",
                    tension: 0.3
                });
            });
    
            if (chartInstance) {
                chartInstance.destroy();
            }
    
            chartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: current.years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "top"
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
    
            graphContainer.style.display = "block";
        }
    
        document.getElementById("generateGraphButton").addEventListener("click", async () => {
            const maxIndex = parseInt(yearRange.value);
            const type = graphTypeSelect.value;
    
            // Pobieranie krajów do porównania
            const selectedOptions = Array.from(compareSelect.selectedOptions);
            const selectedCodes = selectedOptions.map(opt => opt.value);
    
            let extraData = [];
    
            if (selectedCodes.length > 0) {
                const queryParams = selectedCodes.map(code => `countries[]=${code}`).join("&");
                const response = await fetch(`/compare_data/?${queryParams}`);

                const data = await response.json();
    
                // Generowanie losowych kolorów i datasetów
                extraData = data.map(entry => ({
                    name: entry.name,
                    values: entry.total_values,
                    color: getRandomColor()
                }));
            }
    
            renderChart(type, maxIndex, extraData);
        });
    
        function getRandomColor() {
          const r = Math.floor(Math.random() * 255);
          const g = Math.floor(Math.random() * 255);
          const b = Math.floor(Math.random() * 255);
          return `rgba(${r}, ${g}, ${b}, 0.9)`;
        }

        document.getElementById('saveImageButton').addEventListener('click', function () {
        const chartContainer = document.getElementById('graphContainer');

        if (chartContainer.style.display === 'none') {
            alert('Proszę najpierw wygenerować wykres do pobrania');
            return;
        }
    
        chartContainer.scrollIntoView({ behavior: "smooth" });
    
        html2canvas(chartContainer).then(canvas => {
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                // temp link element for download
                const link = document.createElement('a');
                link.href = url;
                link.download = 'energy_production_chart.png';
                link.click();
                // revoke Blob URL
                URL.revokeObjectURL(url);
            }, 'image/png');
        });
});
    
        // Inicjalizacja
        updateChartRange(yearRange.value);
    });
</script>
    
{% endblock page_content %}
